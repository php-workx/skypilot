name: Publish Ojin SkyPilot container

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'version tag override (e.g., 0.10.3-ojin.20251028.1)'
        required: false
        type: string
        default: ''
      build_from_branch:
        description: 'Branch to build from'
        required: true
        type: string
        default: 'ojin-release'

  push:
    branches:
      - 'ojin-release'

env:
  AWS_REGION: eu-central-1
  SKYPILOT_BASE_VERSION: '0.11.1'
  # ECR_REGISTRY will be set dynamically from AWS account

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: write
    strategy:
      matrix:
        image:
          - name: api-server
            dockerfile: Dockerfile
            context: .
            repository: ojin/skypilot
            description: API Server image
          - name: k8s-cpu
            dockerfile: Dockerfile_k8s
            context: ./sky
            repository: ojin/skypilot-k8s
            description: K8s CPU Runtime image

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.build_from_branch || github.ref }}
          fetch-depth: 0  # Full history for version info
          fetch-tags: true

      - name: Get commit info
        id: commit_info
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git show -s --format=%ci HEAD | cut -d' ' -f1)
          echo "sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${COMMIT_SHA}"
          echo "Date: ${COMMIT_DATE}"

      - name: Determine release version tag
        id: version
        env:
          REQUESTED_VERSION_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.version_tag || '' }}
        run: |
          set -euo pipefail
          if [ -n "$REQUESTED_VERSION_TAG" ]; then
            VERSION_TAG="$REQUESTED_VERSION_TAG"
          else
            git fetch origin ojin-release --tags --quiet
            TODAY=$(date -u +%Y%m%d)
            PREFIX="${SKYPILOT_BASE_VERSION}-ojin.${TODAY}."
            LAST_TAG=$(git for-each-ref \
              --merged=refs/remotes/origin/ojin-release \
              --format='%(refname:strip=2)' refs/tags | grep "^${PREFIX}" | sort -V | tail -n 1 || true)
            if [ -z "$LAST_TAG" ]; then
              NEXT_SEQ=1
            else
              LAST_SEQ=${LAST_TAG##${PREFIX}}
              NEXT_SEQ=$((LAST_SEQ + 1))
            fi
            VERSION_TAG="${PREFIX}${NEXT_SEQ}"
          fi
          echo "value=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "VERSION_TAG=${VERSION_TAG}" >> "$GITHUB_ENV"
          echo "Resolved VERSION_TAG=${VERSION_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set ECR repository
        id: ecr-repo
        run: |
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          ECR_REPOSITORY="${{ matrix.image.repository }}"
          echo "registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT
          echo "repository=${ECR_REPOSITORY}" >> $GITHUB_OUTPUT
          echo "ECR Registry: ${ECR_REGISTRY}"
          echo "ECR Repository: ${ECR_REPOSITORY}"
          echo "Image Type: ${{ matrix.image.name }}"
          echo "Description: ${{ matrix.image.description }}"

      - name: Generate image tags
        id: tags
        env:
          VERSION_TAG: ${{ env.VERSION_TAG }}
        run: |
          ECR_REGISTRY="${{ steps.ecr-repo.outputs.registry }}"
          ECR_REPOSITORY="${{ steps.ecr-repo.outputs.repository }}"
          VERSION_TAG="${VERSION_TAG}"
          COMMIT_SHA="${{ steps.commit_info.outputs.sha }}"
          COMMIT_DATE="${{ steps.commit_info.outputs.date }}"

          # Primary tag
          PRIMARY_TAG="${ECR_REGISTRY}/${ECR_REPOSITORY}:${VERSION_TAG}"

          # Additional tags
          COMMIT_TAG="${ECR_REGISTRY}/${ECR_REPOSITORY}:${VERSION_TAG}-${COMMIT_SHA}"

          # Construct tags list
          TAGS="${PRIMARY_TAG},${COMMIT_TAG}"

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "primary_tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT

          echo "Image tags:"
          echo "${TAGS}" | tr ',' '\n'

      - name: Build and push ${{ matrix.image.description }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ./${{ matrix.image.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            TARGETARCH=amd64
            ${{ matrix.image.name == 'api-server' && 'INSTALL_FROM_SOURCE=true' || '' }}
            ${{ matrix.image.name == 'api-server' && 'NEXT_BASE_PATH=/dashboard' || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=Ojin SkyPilot - ${{ matrix.image.description }}
            org.opencontainers.image.description=Custom SkyPilot with various improvements (${{ matrix.image.name }})
            org.opencontainers.image.version=${{ env.VERSION_TAG }}
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ steps.commit_info.outputs.sha }}
            org.opencontainers.image.created=${{ steps.commit_info.outputs.date }}

      - name: Image digest
        run: echo "Built and pushed image with tags ${{ steps.tags.outputs.tags }}"

      - name: Create git tag
        if: github.event_name == 'push' && matrix.image.name == 'api-server'
        run: |
          set -euo pipefail
          VERSION_TAG="${VERSION_TAG:?VERSION_TAG not set}"
          if git ls-remote --tags origin "${VERSION_TAG}" | grep -q "${VERSION_TAG}$"; then
            echo "Git tag ${VERSION_TAG} already exists on remote; skipping creation."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            if ! git rev-parse "${VERSION_TAG}" >/dev/null 2>&1; then
              git tag "${VERSION_TAG}" "${GITHUB_SHA}"
            fi
            git push origin "${VERSION_TAG}"
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Docker Image Build Summary - ${{ matrix.image.description }}

          **Status**: âœ… Success

          ### Image Details
          - **Image Type**: \`${{ matrix.image.name }}\`
          - **Repository**: \`${{ matrix.image.repository }}\`
          - **Primary Tag**: \`${{ steps.tags.outputs.primary_tag }}\`
          - **Commit**: \`${{ steps.commit_info.outputs.sha }}\`
          - **Date**: \`${{ steps.commit_info.outputs.date }}\`
          - **Branch**: \`${{ inputs.build_from_branch || github.ref_name }}\`

          ### All Tags
          \`\`\`
          ${{ steps.tags.outputs.tags }}
          \`\`\`
          EOF

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Docker build or push failed. Check the logs above for details."
          echo "Common issues:"
          echo "  - ECR authentication failure (check AWS credentials/role)"
          echo "  - ECR repository doesn't exist (create it first)"
          echo "  - Insufficient ECR permissions"
          echo "  - Docker build errors (check Dockerfile)"
